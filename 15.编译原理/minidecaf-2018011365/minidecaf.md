# MiniDecaf 编译器

[MiniDecaf](https://decaf-lang.github.io/minidecaf-tutorial/) 是 C 的子集，支持基本的运算/控制流/函数调用/指针/定长数组等操作。

## 一些特性

- if 的 then 子句和 else 子句不能只是一个声明，非法示例

  ```c
  if (1) 
      int a;
  ```

- 全局变量的初始值必须是整数字面量，非法示例

  ```c
  int A = f();
  int B = A;
  ```

- 全局变量不允许重复声明/定义，不能和函数重名

- 三元操作符 ?: 两个子表达式的类型必须是相同的

- if，while，do while，for，?; 的条件必须是 int 型

- 指针类型的表达式仅能参与如下运算：
  类型转换、
  （一元）`&`、`*`、
  （二元）`==`、`!=`、`=`，且要求参与运算的两个指针类型相同

  指针相减，结果为 `int`;

  允许 `int` 加指针和指针加 `int`，以及指针减 `int`，结果都是同类指针。

- 对于 `int* a`, `&(&*a)` 和 `&*a = a` 都是非法的，因为 `&*a` 得到的指针是右值；但解引用操作 `*a` 得到的是左值。

- 所有数组类型都是右值，不能对数组取地址，也没有指向数组的指针。

- 数组定义时不能赋初值，不能作为函数参数。

- 数组类型只支持类型转换和下标运输，不支持赋值。

- 规定赋值表达式的值为，赋值完成后左手边的值。例如 `a=(1+3)` 的值是 `4`。

- 对于函数定义，参数声明所在作用域就是函数体的块语句对应作用域，参数声明可以看成在函数体开头的声明。 因此函数体块语句中不能重新声明参数，除非又有一层块语句.

  ```c
  //int f(int x) { int x; }
  int f(int x) {{ int x; }}
  ```

- 只接受 [0, 2^31-1] 范围内的整数常量，可以配合负号表示负数常量。（`-2147483648` 无法被表示）

## 栈式 IR

| 指令                                | 参数                   | 含义                                                         |
| ----------------------------------- | ---------------------- | ------------------------------------------------------------ |
| `push`                              | 一个整数常数           | 把一个常数压入栈中                                           |
| `ret`                               | 无参数                 | （返回值已经在栈顶了）终止当前函数执行，返回 caller          |
| `neg`、 `not`、 `lnot`              | 无参数                 | 栈顶取负/按位取反/取逻辑非                                   |
| `add`、 `sub`、 `mul`、`div`、`rem` | 无参数                 | 弹出栈顶两个元素，压入它们的和/差/乘除模                     |
| `eq`                                | 无参数                 | `==`（弹出栈顶两个元素，如果相等压入 1，否则压入 0）         |
| `lor`                               | 无参数                 | 弹出栈顶两个元素，将其逻辑或压入栈                           |
| `frameaddr`                         | 一个非负整数常数 `k`   | 把当前栈帧底下开始第 `k` 个元素的地址压入栈中                |
| `load`                              | 无参数                 | 将栈顶弹出，作为地址然后加载该地址的元素（`int`），把加载到的值压入栈中 |
| `store`                             | 无参数                 | 弹出栈顶作为地址，读取新栈顶作为值，将值写入地址开始的 `int` |
| `pop`                               | 无参数                 | 弹出栈顶，忽略得到的值                                       |
| `label`                             | 一个字符串             | 什么也不做，仅标记一个跳转目的地，用参数字符串标识           |
| `beqz`                              | 同上                   | 弹出栈顶元素，如果它等于零，那么跳转到参数标识的 `label` 开始执行 |
| `br`                                | 同上                   | 无条件跳转到参数标识的 `label` 开始执行                      |
| `call`                              | 一个字符串表示函数名   | 调用作为参数的函数，调用完后栈顶是 callee 的返回值           |
| `globaladdr`                        | 一个字符串，表示符号名 | 取得符号名对应的全局变量的地址，压入栈中                     |