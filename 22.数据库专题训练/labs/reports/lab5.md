# Lab5 Report

2018011365 张鹤潇

### 任务概述

在本次实验中，我实现了针对 Insert 的 Undo Log 模块，使数据库满足 Steal/Force 策略，并通过了五次实验所有测例。

### 关键思路和难点

在我们的测试框架里，持久化存储实际是在内存上进行的，利用合并访存请求加速 IO 的 No-Force 策略就失去了意义，因此我选择了 Force 策略。这样一来，Redo Log 也就不必实现。

针对 Insert 的 Undo Log 实现思路如下，

- 在创建 Table 时，为其分配一个专门的 Undo Log 页；
- 插入 Record 时，在 Table 的 Undo Log 页上记录插入项的位置；
- 如果事务 Commit，则将对应 Table 的 Undo Log 页清空；
- 如果在 Commit 之前 Undo，则根据 Undo Log 页回滚插入操作。

具体实现中，我将 Lab4 实现的 `Transaction` 类回滚 Insert 操作功能调整到 `RecoveryManager` 中；只在构造和析构 `RecoveryManager` 时，从持久化介质中读取、写入日志，以提高效率；调整 `TABLE_MANAGER_PAGE`，以存储每个 Table 对应的日志页号。

为了实现这些功能，涉及的 C++ 语法问题和架构调整相当不少，我觉得还是很费精力的。

简单起见，实现中忽略了一些边界情况，如日志页满时的处理。 

### 其它问题

相比 Steal/No-Force 策略，Steal/Force 没有合并多次 Commit 对磁盘的读写，在 Commit 粒度很小且次数很多的情况下，消耗在读写磁盘上的时间会大大增加。我们的实验框架只在启动和停止时读写磁盘，不会出现这种情况。

如果要实现 Steal/No-Force 策略，需要设计 Redo Log 页，在 Insert 时记录插入信息，在 Commit 时做相应标记，数据库宕机后调用 Redo 时恢复最后一次 Commit 之前的记录。

###建议

终于完成了本门课的所有作业，给教学组的建议和意见如下：

- 前两次实验的梯度高，入手难度大

- 后两次实验过于开放

- 课程评分标准非常模糊

- 代码文档不详细，要做什么，该怎么做基本靠同学们自己悟

- 大部分实验代码的质量很高，体现了助教们高超的水平，但我还有一些建议：

  减少裸指针使用，适当用 C++11/14 的新特性降低开发的心智负担。CI 的 C++ 标准固定为 C++11，连 make_unique 都得我自己糊一个。

  也许实验框架可以改用 Java 或者其它语言完成？C++ 实在是太难用了。

- 上课讲授的内容和实验联系不紧密，完成实验不需要听课，或者听课对完成实验没有直接帮助。

到这个学期，一门课上多得几分或者少得几分我是不在乎的，代码、报告、建议，都是随意写写，差不多得了。

